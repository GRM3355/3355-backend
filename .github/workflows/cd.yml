# .github/workflows/cd.yml
name: Zonie CD (Deploy to AWS ECS)

# main 브랜치 race condition 고려; CI에서 먼저 빌드 및 캐싱하고 CD에서는 render와 deploy만
# 'on: push' 대신 'on: workflow_run' 사용
on:
  workflow_run:
    # 'ci.yml' 이름
    workflows: [ "Zonie Backend CI (Build & Test)" ]
    types:
      - completed # CI 워크플로우가 완료되었을 때만 실행
    branches:
      - dev
      - main
env:
  ECR_REGISTRY: 548182874697.dkr.ecr.ap-northeast-2.amazonaws.com
  ECS_CLUSTER: zonie-cluster
  AWS_REGION: ap-northeast-2

  ECR_REPO_API: zonie/api-server
  ECR_REPO_CHAT: zonie/chat-server
  ECR_REPO_BATCH: zonie/batch-server

  ECS_SERVICE_API: zonie-api-service
  ECS_SERVICE_CHAT: zonie-chat-service
  ECS_SERVICE_BATCH: zonie-batch-service

  ECS_TASK_DEF_API: .ecs/task-definition-api.json
  ECS_TASK_DEF_CHAT: .ecs/task-definition-chat.json
  ECS_TASK_DEF_BATCH: .ecs/task-definition-batch.json

  CONTAINER_NAME_API: zonie-api-server
  CONTAINER_NAME_CHAT: zonie-chat-server
  CONTAINER_NAME_BATCH: zonie-batch-server

jobs:
  # ---------------------------------
  # [!! 1. 변경된 파일 감지 Job !!]
  # ---------------------------------
  check-changes:
    name: Check Changed Files
    runs-on: ubuntu-latest
    outputs:
      api-server: ${{ steps.filter.outputs.api-server }}
      chat-server: ${{ steps.filter.outputs.chat-server }}
      batch-server: ${{ steps.filter.outputs.batch-server }}

    # CI 실패시 CD도 실행 안 함
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 변경 사항 비교를 위해 최소 2개 커밋 가져오기
          ref: ${{ github.event.workflow_run.head_sha }} # push 이벤트 말고 CI를 실행시킨 커밋을 기준으로 checkout

      - name: Check for changed files
        uses: dorny/paths-filter@v3
        id: filter
        with:
          # "이번 푸시가 시작되기 전" vs "이번 푸시의 끝" 비교
          base: ${{ github.event.workflow_run.before }} # 푸시 전 커밋 해시
          ref: ${{ github.event.workflow_run.head_sha }}
          filters: |
            # [규칙 1] api-server 또는 common-lib가 바뀌면 'api-server' 배포
            api-server:
              - 'api-server/**'
              - 'common-lib/**'
            # [규칙 2] chat-server 또는 common-lib가 바뀌면 'chat-server' 배포
            chat-server:
              - 'chat-server/**'
              - 'common-lib/**'
            # [규칙 3] batch-server 또는 common-lib가 바뀌면 'batch-server' 배포
            batch-server:
              - 'batch-server/**'
              - 'common-lib/**'

  # ---------------------------------
  # [!! 2. 배포 Job 3개로 분리 !!]
  # ---------------------------------
  deploy-api-server:
    name: Deploy API Server
    runs-on: ubuntu-latest
    needs: check-changes                                  # 1. '파일 감지' Job이 끝날 때까지 대기
    if: needs.check-changes.outputs.api-server == 'true'  # 2. api-server가 변경되었을 때만 실행

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}  # CI 커밋 기준으로 checkout
          fetch-depth: 1 # 추가

      # AWS 로그인 (ECS 배포)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # :latest 대신 CI의 커밋 SHA 사용
      - name: Render API Server Task Definition
        id: render-api-task
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ env.ECS_TASK_DEF_API }}
          container-name: ${{ env.CONTAINER_NAME_API }}
          image: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPO_API }}:${{ github.event.workflow_run.head_sha }}

      - name: Deploy API Server to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        timeout-minutes: 60
        with:
          task-definition: ${{ steps.render-api-task.outputs.task-definition }}
          cluster: ${{ env.ECS_CLUSTER }}
          service: ${{ env.ECS_SERVICE_API }}
          wait-for-service-stability: false # 속도 개선을 위해서 true -> false 변경

  deploy-chat-server:
    name: Deploy Chat Server
    runs-on: ubuntu-latest
    needs: check-changes                                  # 1. '파일 감지' Job이 끝날 때까지 대기
    if: needs.check-changes.outputs.chat-server == 'true' # 2. chat-server가 변경되었을 때만 실행

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}  # CI 커밋 기준으로 checkout

      # AWS 로그인 (ECS 배포)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # :latest 대신 CI의 커밋 SHA 사용
      - name: Render Chat Server Task Definition
        id: render-chat-task
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ env.ECS_TASK_DEF_CHAT }}
          container-name: ${{ env.CONTAINER_NAME_CHAT }}
          image: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPO_CHAT }}:${{ github.event.workflow_run.head_sha }}

      - name: Deploy Chat Server to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        timeout-minutes: 60
        with:
          task-definition: ${{ steps.render-chat-task.outputs.task-definition }}
          cluster: ${{ env.ECS_CLUSTER }}
          service: ${{ env.ECS_SERVICE_CHAT }}
          wait-for-service-stability: true

  deploy-batch-server:
    name: Deploy Batch Server
    runs-on: ubuntu-latest
    needs: check-changes                                    # 1. '파일 감지' Job이 끝날 때까지 대기
    if: needs.check-changes.outputs.batch-server == 'true'  # 2. batch-server가 변경되었을 때만 실행

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}    # CI 커밋 기준으로 checkout

      # AWS 로그인 (ECS 배포)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # :latest 대신 CI의 커밋 SHA 사용
      - name: Render Batch Server Task Definition
        id: render-batch-task
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ env.ECS_TASK_DEF_BATCH }}
          container-name: ${{ env.CONTAINER_NAME_BATCH }}
          image: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPO_BATCH }}:${{ github.event.workflow_run.head_sha }}

      - name: Deploy Batch Server to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        timeout-minutes: 60
        with:
          task-definition: ${{ steps.render-batch-task.outputs.task-definition }}
          cluster: ${{ env.ECS_CLUSTER }}
          service: ${{ env.ECS_SERVICE_BATCH }}
          wait-for-service-stability: true