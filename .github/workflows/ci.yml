# .github/workflows/ci.yml
# "Zonie Backend CI" - GitHub Actions에 표시될 워크플로우 이름
name: Zonie Backend CI (Build & Test)

# 1. 트리거 (Trigger)
# 'main' 브랜치에 push 되거나,
# 'main' 브랜치로 향하는 Pull Request가 생성/수정될 때 실행
on:
  push:
    branches: [ "dev" ]
  pull_request:
    branches: [ "dev" ]

# 2. 작업 (Jobs)
jobs:
  build-and-test:
    # 실행 환경: 최신 Ubuntu
    runs-on: ubuntu-latest
    env:
      SPRING_PROFILES_ACTIVE: test

    # 3. 단계 (Steps)
    steps:
      # 1단계: Git 레포지토리 코드 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2단계: Java 21 (Temurin) 환경 설정
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin' # Eclipse Temurin (구 AdoptOpenJDK)

      # 3단계: Gradle 캐시 설정 (빌드 속도 향상)
      # gradle-wrapper.properties나 build.gradle 파일이 바뀔 때만 캐시를 새로 만듦
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4단계: gradlew 실행 권한 부여
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # 5단계: Gradle로 빌드 및 테스트 (분리해서)
      # --no-daemon: CI 환경에서는 데몬을 사용하지 않는 것이 좋음
      # 5-1: Gradle로 빌드 실행 (테스트 제외)
      - name: Build with Gradle
        run: ./gradlew build -x test --no-daemon

      # 5-2: Gradle로 테스트 실행
      - name: Test with Gradle
        env:
          # Postgres 설정 (CI 서비스 컨테이너와 일치시킴)
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/zonie_main
          SPRING_DATASOURCE_USERNAME: zonie
          SPRING_DATASOURCE_PASSWORD: zonie_pass
          # Redis 설정
          SPRING_DATA_REDIS_HOST: localhost
          SPRING_DATA_REDIS_PORT: 6379
          # Mongo 설정
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/zonie_chat
        run: ./gradlew test --no-daemon

      # 6단계: Docker Buildx 설정 (모든 Docker 빌드 Job이 공통으로 사용)
      - name: Set up Docker Build
        uses: docker/setup-buildx-action@v3

      # 7단계: AWS 자격 증명 (ECR 푸시)
      - name: Configure AWS Credentials
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # 8단계: ECR 로그인 (ECR 푸시)
      - name: Login to Amazon ECR
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev'
        uses: aws-actions/amazon-ecr-login@v2

      # 9단계: Docker 이미지 빌드 테스트 - 캐싱 적용
      # 9-1: API 서버
      - name: Build (and Push) Docker Image (API Server)
        uses: docker/build-push-action@v5
        with:
          context: . # 빌드 컨텍스트
          file: ./api-server/Dockerfile # Dockerfile 위치
          tags: 548182874697.dkr.ecr.ap-northeast-2.amazonaws.com/zonie/api-server:${{ github.sha }}
          # PR일 땐 푸시 안하고, Push일 때 main, dev 브랜치에서만 푸시
          push: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev') }}
          cache-from: type=gha,scope=${{ github.workflow }}-api             # API 서버 전용 캐시 scope
          cache-to: type=gha,scope=${{ github.workflow }}-api,mode=max

      # 9-2: Chat 서버
      - name: Build (and Push) Docker Image (Chat Server)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./chat-server/Dockerfile
          tags: 548182874697.dkr.ecr.ap-northeast-2.amazonaws.com/zonie/chat-server:${{ github.sha }}
          # PR일 땐 푸시 안하고, Push일 때 main, dev 브랜치에서만 푸시
          push: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev') }}
          cache-from: type=gha,scope=${{ github.workflow }}-chat            # chat 서버 전용 캐시 scope
          cache-to: type=gha,scope=${{ github.workflow }}-chat,mode=max

      # 9-3: Batch 서버
      - name: Build (and Push) Docker Image (Batch Server)
        uses: docker/build-push-action@v5
        with:
          context: . # 루트에서 실행
          file: ./batch-server/Dockerfile # 배치 서버 Dockerfile 경로
          tags: 548182874697.dkr.ecr.ap-northeast-2.amazonaws.com/zonie/batch-server:${{ github.sha }}
          # PR일 땐 푸시 안하고, Push일 때 main, dev 브랜치에서만 푸시
          push: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev') }}
          cache-from: type=gha,scope=${{ github.workflow }}-batch           # batch 서버 전용 캐시 scope
          cache-to: type=gha,scope=${{ github.workflow }}-batch,mode=max

      # 10단계: 테스트 실패 시 리포트 업로드
      # 'failure()'를 사용하여 이전 단계가 실패했을 때만 실행
      - name: Upload Test Reports on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: '**/build/reports/tests/test'